{
  "name": "Batch PDF Ingestion - Klasor Yukleyici",
  "nodes": [
    {
      "parameters": {},
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [-800, 0],
      "id": "a1b2c3d4-0001-4000-8000-000000000001",
      "name": "Baslat"
    },
    {
      "parameters": {
        "jsCode": "// =====================================================\n// AYARLAR - HER KLASOR ICIN BURADAN DEGISTIR\n// =====================================================\n// Her calistirmada sadece BIR klasor yukle.\n// Bitince folderPath, collection, folderTag degistirip tekrar calistir.\n//\n// YUKLEME SIRASI (oneri):\n// 1) MACHINERY       -> ship_machinery\n// 2) ACCOMMODATION   -> ship_accommodation\n// 3) HULL PIPING     -> ship_hull_piping\n// 4) HULL OUTFITTING -> ship_hull_outfitting\n// 5) BWTS TRAINING   -> ship_bwts_training\n// 6) F               -> ship_f\n// 7) 8189 YARD DWG   -> ship_8189_yard_dwg\n// 8) BRIDGE_ EQUIPMENT -> ship_bridge_equipment  (en buyuk, en son)\n//\n// NOT: ELECTRIC ve CCR zaten yuklu, tekrar yuklemeyin!\n// =====================================================\n\nconst CONFIG = {\n  folderPath: \"D:/MANTA ANADOLU/MACHINERY/*.pdf\",\n  collection: \"ship_machinery\",\n  folderTag: \"MACHINERY\",\n  chunkSize: 800,\n  chunkOverlap: 150\n};\n\nreturn [{ json: CONFIG }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [-480, 0],
      "id": "a1b2c3d4-0002-4000-8000-000000000002",
      "name": "CONFIG"
    },
    {
      "parameters": {
        "fileSelector": "={{ $json.folderPath }}",
        "options": {}
      },
      "type": "n8n-nodes-base.readWriteFile",
      "typeVersion": 1.1,
      "position": [-140, 0],
      "id": "a1b2c3d4-0003-4000-8000-000000000003",
      "name": "Tum PDF Oku"
    },
    {
      "parameters": {
        "batchSize": 1,
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [200, 0],
      "id": "a1b2c3d4-0004-4000-8000-000000000004",
      "name": "Tek Tek Yukle"
    },
    {
      "parameters": {
        "operation": "pdf",
        "options": {}
      },
      "type": "n8n-nodes-base.extractFromFile",
      "typeVersion": 1.1,
      "position": [540, 0],
      "id": "a1b2c3d4-0005-4000-8000-000000000005",
      "name": "PDF Text Cikar"
    },
    {
      "parameters": {
        "jsCode": "// SMART CHUNKER - Overlap ile akilli parcalama + metadata\n\nconst config = $node[\"CONFIG\"].json;\nconst text = items[0].json.text || items[0].json.data || \"\";\n\n// Dosya adini binary metadata'dan al\nlet fileName = \"unknown\";\ntry {\n  const binaryKeys = Object.keys(items[0].binary || {});\n  if (binaryKeys.length > 0) {\n    fileName = items[0].binary[binaryKeys[0]].fileName || \"unknown\";\n  }\n} catch(e) {}\nfileName = fileName.replace(/\\.pdf$/i, '');\n\nif (!text || text.length < 50) {\n  return [{\n    json: {\n      pageContent: \"[Bu PDF'den metin cikarilmadi: \" + fileName + \"]\",\n      metadata: {\n        sourceName: fileName,\n        fileName: fileName,\n        source: fileName,\n        folder: config.folderTag,\n        page: 0,\n        chunk: 0\n      }\n    }\n  }];\n}\n\nconst chunkSize = config.chunkSize || 800;\nconst overlap = config.chunkOverlap || 150;\nconst chunks = [];\n\nconst pages = text.split(/\\f/);\nif (pages.length <= 1) {\n  pages.length = 0;\n  pages.push(text);\n}\n\nlet globalChunkIndex = 0;\n\nfor (let pageIdx = 0; pageIdx < pages.length; pageIdx++) {\n  const pageText = pages[pageIdx].trim();\n  if (pageText.length < 30) continue;\n  \n  let pos = 0;\n  while (pos < pageText.length) {\n    let end = Math.min(pos + chunkSize, pageText.length);\n    \n    if (end < pageText.length) {\n      const lastPeriod = pageText.lastIndexOf('.', end);\n      const lastNewline = pageText.lastIndexOf('\\n', end);\n      const bestBreak = Math.max(lastPeriod, lastNewline);\n      if (bestBreak > pos + chunkSize * 0.4) {\n        end = bestBreak + 1;\n      }\n    }\n    \n    const chunkText = pageText.substring(pos, end).trim();\n    \n    if (chunkText.length > 30) {\n      chunks.push({\n        json: {\n          pageContent: chunkText,\n          metadata: {\n            sourceName: fileName,\n            fileName: fileName,\n            source: fileName,\n            folder: config.folderTag,\n            page: pageIdx + 1,\n            chunk: globalChunkIndex\n          }\n        }\n      });\n      globalChunkIndex++;\n    }\n    \n    pos = end - overlap;\n    if (pos <= 0 && end >= pageText.length) break;\n    if (end >= pageText.length) break;\n  }\n}\n\nif (chunks.length === 0) {\n  return [{\n    json: {\n      pageContent: \"PDF icerigi bos: \" + fileName,\n      metadata: {\n        sourceName: fileName,\n        fileName: fileName,\n        source: fileName,\n        folder: config.folderTag,\n        page: 0,\n        chunk: 0\n      }\n    }\n  }];\n}\n\nreturn chunks;\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [880, 0],
      "id": "a1b2c3d4-0006-4000-8000-000000000006",
      "name": "SMART_CHUNKER"
    },
    {
      "parameters": {
        "mode": "insert",
        "qdrantCollection": {
          "__rl": true,
          "value": "={{ $node[\"CONFIG\"].json.collection }}",
          "mode": "id"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.vectorStoreQdrant",
      "typeVersion": 1.3,
      "position": [1240, 0],
      "id": "a1b2c3d4-0007-4000-8000-000000000007",
      "name": "Qdrant Yukle",
      "credentials": {
        "qdrantApi": {
          "id": "X0pbbSADyJw0n4U8",
          "name": "QdrantApi account"
        }
      }
    },
    {
      "parameters": {
        "model": "nomic-embed-text:latest"
      },
      "type": "@n8n/n8n-nodes-langchain.embeddingsOllama",
      "typeVersion": 1,
      "position": [1160, 240],
      "id": "a1b2c3d4-0008-4000-8000-000000000008",
      "name": "Embeddings Ollama",
      "credentials": {
        "ollamaApi": {
          "id": "m56zkpBYscfCoPii",
          "name": "Ollama account"
        }
      }
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.documentDefaultDataLoader",
      "typeVersion": 1.1,
      "position": [1320, 240],
      "id": "a1b2c3d4-0009-4000-8000-000000000009",
      "name": "Default Data Loader"
    }
  ],
  "pinData": {},
  "connections": {
    "Baslat": {
      "main": [
        [
          {
            "node": "CONFIG",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "CONFIG": {
      "main": [
        [
          {
            "node": "Tum PDF Oku",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Tum PDF Oku": {
      "main": [
        [
          {
            "node": "Tek Tek Yukle",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Tek Tek Yukle": {
      "main": [
        [
          {
            "node": "PDF Text Cikar",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "PDF Text Cikar": {
      "main": [
        [
          {
            "node": "SMART_CHUNKER",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "SMART_CHUNKER": {
      "main": [
        [
          {
            "node": "Qdrant Yukle",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Qdrant Yukle": {
      "main": [
        [
          {
            "node": "Tek Tek Yukle",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Embeddings Ollama": {
      "ai_embedding": [
        [
          {
            "node": "Qdrant Yukle",
            "type": "ai_embedding",
            "index": 0
          }
        ]
      ]
    },
    "Default Data Loader": {
      "ai_document": [
        [
          {
            "node": "Qdrant Yukle",
            "type": "ai_document",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1",
    "timeSavedMode": "fixed",
    "timezone": "Europe/Istanbul",
    "callerPolicy": "workflowsFromSameOwner"
  },
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "1f3bb329867d83a64a7fcb9eea21ec33827ac4bebf2b87637c3c03f57702477f"
  },
  "tags": []
}
