{
  "name": "ÜRETİM HATTI",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "tools/create_n8n_flow",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [240, 300],
      "id": "327c7b9f-29e6-4748-8002-28947fdcbd87",
      "name": "TOOL_create_n8n_flow",
      "webhookId": "b145b66e-4470-419c-a0a2-83b4aa5c206d"
    },
    {
      "parameters": {
        "jsCode": "// Webhook'tan gelen komutu al\nconst req = $input.first().json;\nconst body = req.body || {};\nconst desc = (body.description || '').toLowerCase();\nconst name = body.workflowName || 'ARGUS Akış';\n\n// UUID generator\nfunction uuid() {\n  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {\n    const r = Math.random() * 16 | 0;\n    return (c === 'x' ? r : (r & 0x3 | 0x8)).toString(16);\n  });\n}\n\n// Workflow templates\nlet workflow = null;\n\n// ═══════════════════════════════════════════════════════════\n// TEMPLATE 1: BTC Fiyatı + Twilio Araması\n// ═══════════════════════════════════════════════════════════\nif (desc.includes('btc') || desc.includes('bitcoin')) {\n  const schedule = desc.includes('17:15') ? '15 17 * * *' : '0 9 * * *';\n  \n  workflow = {\n    name: `${name} - BTC Fiyat Araması`,\n    nodes: [\n      {\n        parameters: {\n          rule: {\n            interval: [{ field: 'cronExpression', expression: schedule }]\n          }\n        },\n        type: 'n8n-nodes-base.scheduleTrigger',\n        typeVersion: 1.2,\n        position: [240, 300],\n        id: uuid(),\n        name: 'Her Gün Çalış'\n      },\n      {\n        parameters: {\n          url: 'https://api.coingecko.com/api/v3/simple/price',\n          sendQuery: true,\n          queryParameters: {\n            parameters: [\n              { name: 'ids', value: 'bitcoin' },\n              { name: 'vs_currencies', value: 'usd,try' }\n            ]\n          },\n          options: { response: { response: { responseFormat: 'json' } } }\n        },\n        type: 'n8n-nodes-base.httpRequest',\n        typeVersion: 4.2,\n        position: [460, 300],\n        id: uuid(),\n        name: 'BTC Fiyat Çek'\n      },\n      {\n        parameters: {\n          jsCode: `const btc = $json.bitcoin;\nconst usd = Math.round(btc.usd);\nconst tryPrice = Math.round(btc.try);\nconst message = \\`Bitcoin'in anlık fiyatı ${usd} dolar, yani ${tryPrice.toLocaleString('tr-TR')} Türk Lirası\\`;\nconst to = process.env.ALERT_TARGET_NUMBER;\nconst from = process.env.TWILIO_PHONE_NUMBER;\nconst twiml = \\`<Response><Say language='tr-TR'>\${message}</Say><Pause length='1'/><Say language='tr-TR'>Başka bir şey ister misin?</Say></Response>\\`;\nreturn [{ json: { to, from, twiml, usd, tryPrice } }];`\n        },\n        type: 'n8n-nodes-base.code',\n        typeVersion: 2,\n        position: [680, 300],\n        id: uuid(),\n        name: 'TwiML Hazırla'\n      },\n      {\n        parameters: {\n          method: 'POST',\n          url: '=https://api.twilio.com/2010-04-01/Accounts/{{$env.TWILIO_ACCOUNT_SID}}/Calls.json',\n          authentication: 'genericCredentialType',\n          genericAuthType: 'httpBasicAuth',\n          sendBody: true,\n          contentType: 'raw',\n          rawContentType: '=application/x-www-form-urlencoded',\n          body: `={{ 'To=' + encodeURIComponent($json.to) + '&From=' + encodeURIComponent($json.from) + '&Twiml=' + encodeURIComponent($json.twiml) }}`,\n          options: {}\n        },\n        type: 'n8n-nodes-base.httpRequest',\n        typeVersion: 4.3,\n        position: [900, 300],\n        id: uuid(),\n        name: 'Twilio Araması',\n        credentials: { httpBasicAuth: { id: 'Tn2UknHXfLcUtpyN', name: 'Twilio Credentials' } }\n      },\n      {\n        parameters: {\n          method: 'POST',\n          url: '=https://api.telegram.org/bot{{$env.TELEGRAM_BOT_TOKEN}}/sendMessage',\n          sendBody: true,\n          bodyParameters: {\n            parameters: [\n              { name: 'chat_id', value: '1496380263' },\n              { name: 'text', value: '=✅ BTC: ${{$json.usd}} ({{$json.tryPrice}} TL) - Seni aradım!' }\n            ]\n          },\n          options: {}\n        },\n        type: 'n8n-nodes-base.httpRequest',\n        typeVersion: 4.2,\n        position: [1120, 300],\n        id: uuid(),\n        name: 'Telegram Bildir'\n      }\n    ],\n    connections: {\n      'Her Gün Çalış': { main: [[{ node: 'BTC Fiyat Çek', type: 'main', index: 0 }]] },\n      'BTC Fiyat Çek': { main: [[{ node: 'TwiML Hazırla', type: 'main', index: 0 }]] },\n      'TwiML Hazırla': { main: [[{ node: 'Twilio Araması', type: 'main', index: 0 }]] },\n      'Twilio Araması': { main: [[{ node: 'Telegram Bildir', type: 'main', index: 0 }]] }\n    },\n    active: false,\n    settings: { executionOrder: 'v1' }\n  };\n}\n\n// ═══════════════════════════════════════════════════════════\n// TEMPLATE 2: Gmail Son 3 E-posta Özeti\n// ═══════════════════════════════════════════════════════════\nelse if (desc.includes('mail') || desc.includes('e-posta') || desc.includes('eposta')) {\n  workflow = {\n    name: `${name} - Gmail Özet`,\n    nodes: [\n      {\n        parameters: {},\n        type: 'n8n-nodes-base.manualTrigger',\n        typeVersion: 1,\n        position: [240, 300],\n        id: uuid(),\n        name: 'Manuel Başlat'\n      },\n      {\n        parameters: {\n          jsCode: `// Gmail API kullanarak son 3 e-postayı çek\nconst response = await fetch('https://gmail.googleapis.com/gmail/v1/users/me/messages?maxResults=3', {\n  headers: { 'Authorization': \\`Bearer \${process.env.GMAIL_ACCESS_TOKEN}\\` }\n});\nconst data = await response.json();\nreturn data.messages?.map(m => ({ json: { id: m.id } })) || [];`\n        },\n        type: 'n8n-nodes-base.code',\n        typeVersion: 2,\n        position: [460, 300],\n        id: uuid(),\n        name: 'Gmail Listele'\n      },\n      {\n        parameters: {\n          method: 'POST',\n          url: '=https://api.telegram.org/bot{{$env.TELEGRAM_BOT_TOKEN}}/sendMessage',\n          sendBody: true,\n          bodyParameters: {\n            parameters: [\n              { name: 'chat_id', value: '1496380263' },\n              { name: 'text', value: '=Son 3 e-posta: {{$json.summary}}' }\n            ]\n          },\n          options: {}\n        },\n        type: 'n8n-nodes-base.httpRequest',\n        typeVersion: 4.2,\n        position: [680, 300],\n        id: uuid(),\n        name: 'Telegram Gönder'\n      }\n    ],\n    connections: {\n      'Manuel Başlat': { main: [[{ node: 'Gmail Listele', type: 'main', index: 0 }]] },\n      'Gmail Listele': { main: [[{ node: 'Telegram Gönder', type: 'main', index: 0 }]] }\n    },\n    active: false,\n    settings: { executionOrder: 'v1' }\n  };\n}\n\n// ═══════════════════════════════════════════════════════════\n// TEMPLATE 3: YouTube En Çok İzlenen Videolar\n// ═══════════════════════════════════════════════════════════\nelse if (desc.includes('youtube') || desc.includes('video')) {\n  workflow = {\n    name: `${name} - YouTube Trend`,\n    nodes: [\n      {\n        parameters: {},\n        type: 'n8n-nodes-base.manualTrigger',\n        typeVersion: 1,\n        position: [240, 300],\n        id: uuid(),\n        name: 'Manuel Başlat'\n      },\n      {\n        parameters: {\n          url: 'https://www.googleapis.com/youtube/v3/search',\n          sendQuery: true,\n          queryParameters: {\n            parameters: [\n              { name: 'part', value: 'snippet' },\n              { name: 'type', value: 'video' },\n              { name: 'order', value: 'viewCount' },\n              { name: 'publishedAfter', value: '={{new Date(Date.now() - 24*60*60*1000).toISOString()}}' },\n              { name: 'maxResults', value: '3' },\n              { name: 'regionCode', value: 'TR' },\n              { name: 'key', value: '={{$env.YOUTUBE_API_KEY}}' }\n            ]\n          },\n          options: { response: { response: { responseFormat: 'json' } } }\n        },\n        type: 'n8n-nodes-base.httpRequest',\n        typeVersion: 4.2,\n        position: [460, 300],\n        id: uuid(),\n        name: 'YouTube Ara'\n      },\n      {\n        parameters: {\n          jsCode: `const items = $json.items || [];\nconst videos = items.slice(0, 3).map((v, i) => \\`\${i+1}. \${v.snippet.title}\\`);\nconst message = 'Son 24 saatte en çok izlenen videolar:\\\\n' + videos.join('\\\\n');\nreturn [{ json: { message } }];`\n        },\n        type: 'n8n-nodes-base.code',\n        typeVersion: 2,\n        position: [680, 300],\n        id: uuid(),\n        name: 'Video Listesi Hazırla'\n      },\n      {\n        parameters: {\n          method: 'POST',\n          url: '=https://api.telegram.org/bot{{$env.TELEGRAM_BOT_TOKEN}}/sendMessage',\n          sendBody: true,\n          bodyParameters: {\n            parameters: [\n              { name: 'chat_id', value: '1496380263' },\n              { name: 'text', value: '={{$json.message}}' }\n            ]\n          },\n          options: {}\n        },\n        type: 'n8n-nodes-base.httpRequest',\n        typeVersion: 4.2,\n        position: [900, 300],\n        id: uuid(),\n        name: 'Telegram Gönder'\n      }\n    ],\n    connections: {\n      'Manuel Başlat': { main: [[{ node: 'YouTube Ara', type: 'main', index: 0 }]] },\n      'YouTube Ara': { main: [[{ node: 'Video Listesi Hazırla', type: 'main', index: 0 }]] },\n      'Video Listesi Hazırla': { main: [[{ node: 'Telegram Gönder', type: 'main', index: 0 }]] }\n    },\n    active: false,\n    settings: { executionOrder: 'v1' }\n  };\n}\n\n// ═══════════════════════════════════════════════════════════\n// FALLBACK: Genel Template\n// ═══════════════════════════════════════════════════════════\nelse {\n  workflow = {\n    name: `${name} - Genel`,\n    nodes: [\n      {\n        parameters: {},\n        type: 'n8n-nodes-base.manualTrigger',\n        typeVersion: 1,\n        position: [240, 300],\n        id: uuid(),\n        name: 'Başlat'\n      },\n      {\n        parameters: {\n          jsCode: `return [{ json: { message: 'Workflow oluşturuldu: ${desc}' } }];`\n        },\n        type: 'n8n-nodes-base.code',\n        typeVersion: 2,\n        position: [460, 300],\n        id: uuid(),\n        name: 'İşle'\n      }\n    ],\n    connections: {\n      'Başlat': { main: [[{ node: 'İşle', type: 'main', index: 0 }]] }\n    },\n    active: false,\n    settings: { executionOrder: 'v1' }\n  };\n}\n\nif (!workflow) {\n  throw new Error('Workflow template bulunamadı');\n}\n\nreturn [{ json: { apiWorkflow: workflow } }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [460, 300],
      "id": "494b6748-7d46-48d6-a0f5-a157e3f02097",
      "name": "WORKFLOW BUILDER"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://127.0.0.1:5678/api/v1/workflows",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-N8N-API-KEY",
              "value": "={{$env.N8N_API_KEY}}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify($json.apiWorkflow) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [680, 300],
      "id": "5b1d85ec-080d-4bc9-a370-9233932c4186",
      "name": "n8n API - Workflow Oluştur"
    },
    {
      "parameters": {
        "jsCode": "const item = $input.first().json;\nconst data = item.data || item;\n\nif (!data || !data.id) {\n  return [{\n    json: {\n      ok: false,\n      error: item.message || item.error || 'Workflow oluşturulamadı',\n      raw: item\n    }\n  }];\n}\n\nreturn [{\n  json: {\n    ok: true,\n    workflowId: data.id,\n    name: data.name,\n    reply: `✅ Workflow oluşturuldu: ${data.name}\\nID: ${data.id}\\nURL: https://argusbot.duckdns.org/workflow/${data.id}`,\n    url: `https://argusbot.duckdns.org/workflow/${data.id}`\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [900, 300],
      "id": "2ed90e95-4ce6-455b-85ac-0d7cfaadd1ef",
      "name": "Response Builder"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json }}",
        "options": {
          "responseCode": 200
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [1120, 300],
      "id": "a352105e-1d21-492b-b462-395c8c79d2b3",
      "name": "Respond to Webhook"
    }
  ],
  "pinData": {},
  "connections": {
    "TOOL_create_n8n_flow": {
      "main": [[{ "node": "WORKFLOW BUILDER", "type": "main", "index": 0 }]]
    },
    "WORKFLOW BUILDER": {
      "main": [[{ "node": "n8n API - Workflow Oluştur", "type": "main", "index": 0 }]]
    },
    "n8n API - Workflow Oluştur": {
      "main": [[{ "node": "Response Builder", "type": "main", "index": 0 }]]
    },
    "Response Builder": {
      "main": [[{ "node": "Respond to Webhook", "type": "main", "index": 0 }]]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1",
    "timezone": "Europe/Istanbul",
    "callerPolicy": "workflowsFromSameOwner"
  },
  "versionId": "workflow-builder-v2",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "b3095fc29cb871b1a1fa62649bfd13016a8a983bdcd4a1523275b8f83ce36cce"
  },
  "id": "0OvLyVNV4rEQp2qz",
  "tags": []
}

